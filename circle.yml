machine:
  services:
    - redis
    - docker
  node:
    version: 6.5.0
  environment:
    # AWS_ACCOUNT_ID
    # AWS_DEFAULT_REGION
    # AWS_ACCESS_KEY_ID
    # AWS_SECRET_ACCESS_KEY
    APP_NAME: hotvenue-server

dependencies:
  post:
    - npm install sqlite3
    - pip install awscli
    - docker build --rm=false -t $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$APP_NAME:$CIRCLE_BUILD_NUM .
    - aws configure set default.region $AWS_DEFAULT_REGION
    - aws configure set default.output json
    - eval $(aws ecr get-login)

test:
  post:
    - docker run -p 3000:3000 -e "CIRCLECI=yes" --net="host" $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$APP_NAME:$CIRCLE_BUILD_NUM
    - sleep 10
    - curl --retry 10 --retry-delay 5 http://127.0.0.1:3000
    - docker ps

# deployment:
#   ecs:
#     branch: master
#     commands:
#       - docker push $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/$APP_NAME:$CIRCLE_BUILD_NUM
